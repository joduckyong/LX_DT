{{>layout/header}}

        <div class="right_col" role="main">
          <div class="row">
            <div class="col-md-12">
              <div class="x_panel"> 
                <div class="x_title"> 
                  <h2>HOME > Adapter 관리 > Adapter 설정</h2>
                  <div class="clearfix"> </div>
                </div>
                <div class="x_content"> <br>
                  <div class="cont_title_box">
                    <h3>Instance 매칭정보 설정</h3>
                  </div>
                  <div class="border_rows">
                    <div class="row">
                      <div class="form-group row col-12 col-md-6">
                        <div class="control-label" style="text-align: center;">인스턴스 명</div>
                        <div class="form-control_box"><span id="instance_nm_txt"></span></div>
                      </div>
                      <div class="form-group row col-12 col-md-6">
                        <div class="control-label" style="text-align: center;">데이터 셋 명</div>
                        <div class="form-control_box"><span id="dset_korean_nm_txt"></span></div>
                      </div>
                    </div>
				  </div>
	              <div class="cont_title_box">
	                <h3></h3>
	                <div class="right_btns">
	                	<a class="btn btn-primary" href="javascript:openModal('apiDataSet');">API 데이터 설정 </a>
	                	<a class="btn btn-success" href="javascript:listPage();">목록 </a>
	                	<a class="btn btn-primary" href="javascript:dpIngestAdapterItMatchSave();">저장 </a>
	                </div>
	              </div>
				  <div class="border_rows">
                    <div class="row">
                      <div class="form-group row col-12 col-md-12">
                        <div class="control-label">PK데이터 설정</div>
                        <div class="form-control_box">	
                            <div class="right_btns">
                           		<a class="btn btn-primary" href="javascript:openModal('idSet');">ID설정</a>
                            </div>
                            <h3></h3>
                            <input class="form-control" type="text" name="pk_data_set" id="pk_data_set" readonly>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <div class="cont_title_box">
                  </div>
                                    
                  <div class="table_responsive">
					<table class="table table-bordered bulk_action table_center" id="tableDpIngestAdapterItMatchList">
                      <colgroup> 
                      </colgroup>
                      <thead>
                        <tr> 
                          <th colspan="2">데이터 모델</th>
                          <th colspan="2">Source</th>
                          <th colspan="3">전처리</th>
                        </tr>
                        <tr>
                          <th>속성ID</th>
                          <th>속성값</th>
                          <th>ID</th>
                          <th>수신경로</th>
                          <th>전처리명</th>
                          <th>속성유형</th>
                          <th>예시</th>
                        </tr>
                      </thead>
                      <tbody id="dpIngestAdapterItMatchList">
                      </tbody>
                    </table>
                    
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ID 설정 modal -->
        <div class="modal fade idSetting_modal" id="idSet" tabindex="-1" role="dialog" aria-hidden="true">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h3 class="modal-title" id="myModalLabel">ID 설정</h3>
                <button class="close" type="button" data-dismiss="modal"></button><span aria-hidden="true">&times;</span>
              </div>
              <div class="modal-body">
                <div class="main-container">
                  <ul class="columns">
                    <li class="column to-do-column">
                      <div class="column-header">
                        <h4>ID 목록</h4>
                      </div>
                      <div class="column-header">
                      	<h4>ID영문명(Type)</h4>
                      </div>
                      <ul class="task-list" id="drakeLeft">
                      </ul>
                    </li>
                    <li class="column doing-column">
                      <div class="column-header">
                        <h4>선택 ID</h4>
                      </div>
                      <div class="column-header">
						<h4>ID영문명(Type)</h4>               
                      </div>                      
                      <ul class="task-list" id="drakeRight">
                      </ul>
                    </li>
                  </ul>
                </div>
                <div class="drake_result_box">
                  <div class="drake_title">ID</div>
                  <div class="drake_result"></div>
                  <button class="btn btn-danger m-0" onclick="dpIngestDataModelsPpInit();">초기화</button>
                </div>
              </div>
              <div class="modal-footer"> 
                <button class="btn btn-primary" onclick="idSetIdMix();" type="button">선택</button>
              </div>
            </div>
          </div>
        </div>        
        
        <!-- API 데이터 설정 modal -->
        <div class="modal fade add_modal" id="apiDataSet" tabindex="-1" role="dialog" aria-hidden="true">
	      <div class="modal-dialog modal-xl"  style="max-width: 600px;">
	        <div class="modal-content">
	          <div class="modal-header">
	            <h3 class="modal-title" id="apiDataSetTxt">API 데이터 설정</h3>
	            <button class="close" type="button" data-dismiss="modal"></button><span aria-hidden="true">&times;</span>
	          </div>
	          <div class="modal-body">
	          	<div class="x_content" >
	            	<div class="row">
	            		<div class="table_responsive" style="max-height:500px; overflow-y:auto;">
		                    <table class="table" style="text-align: center;" id="tableDpIngestPopupPpPath" >
		                      <thead>
		                        <tr> 
		                          <th>선택</th>
		                          <th>수신 경로</th>
		                          <th>항목명</th>
		                        </tr>
		                      </thead>
		                      <tbody id="dpIngestPopupPpPath" >
		                      </tbody>
		                    </table>
		               	</div>
	             	</div>
	             </div>
	           </div>
	           <div class="modal-footer" id="modal_footer">
	           	<button class="btn btn-primary" type="button" onclick="dpIngestPopupPpPathSave();">저장</button>
	           </div>
	         </div>
	       </div>
       </div>
       
       
       <div id="divForm"></div>
       <input type="hidden" name="dset_idntfc_id" id="dset_idntfc_id">
       <input type="hidden" name="url_mix" id="url_mix">
       <input type="hidden" name="id_mix" id="id_mix">
       <input type="hidden" name="clct_mthd" id="clct_mthd">
       <input type="hidden" name="clct_ty" id="clct_ty">
       <input type="hidden" name="subfolder_yn" id="subfolder_yn">
       <input type="hidden" name="api_mix" id="api_mix">
       <input type="hidden" name="table_eng_nm" id="table_eng_nm">
       <input type="hidden" name="table_idntfc_id" id="table_idntfc_id">
       <input type="hidden" name="drake_pre" id="drake_pre">
       
{{>layout/footer}}        

<script>
const commonUrl = '/common';
const url = '/adaptor';

let dpIngestAdapterItSourceData;
let dpIngestAdapterItPreData;

//Adapter 상세
const listPage = function(){
	location.href = url+'/detail/{{adapter_id}}';
}

//Instance 매칭정보 리스트 조회
const dpIngestMetaTblCol = function(){

	$("#dpIngestAdapterItMatchList").empty();	
	
	console.log('table_idntfc_id : '+$("#table_idntfc_id").val());
    const data = {
	   		url: '/dp/ingest/meta/tables/column',
	   		table_idntfc_id: $("#table_idntfc_id").val(),	
	   		user_id: 'user00',	
	   		menu_id: 'menu_id',
	    };		
	    
	    $.ajax({
	        type: 'POST',
	        url: url+'/dpIngestMetaTblCol',
	        dataType: 'json',
	        contentType: 'application/json; charset-utf-8',
	        data: JSON.stringify(data)
	    }).done(function (data) {
	    	
		  	  if (data != null) {
		  		  
	    		  if(errorMsg(data)){
	  	          	 return;  
        	  	  }	
		  		
			  	   	if(data.contents != ""){    	
			  	   		
    		     	    let insertTr = '';
    			  	    $.each(data.contents, function (idx, el) {
    			  	    	
    		     	          insertTr += '<tr>';
    		     		      insertTr += ' <td><input type=hidden id="column_eng_nm" name="column_eng_nm" value="'+el.column_eng_nm+'">'+el.column_eng_nm+'</td>';
    		     		      insertTr += ' <td><input type=hidden id="column_stre_type" name="column_stre_type" value="'+el.column_stre_type+'">'+el.column_stre_type+'</td>';
    		     		      insertTr += ' <td><select id="source_id" name="source_id" onchange="sourceIdChange('+idx+', this.value);"><option value="">선택</option>';
    		     		      $.each(dpIngestAdapterItSourceData, function (idx2, el2) {
    			     		      insertTr += ' <option value="'+el2.source_id+'" '+(el2.source_id === el.source_id?"selected":"")+'>'+el2.source_id+'</option>';
    		     		      });		     		      
    		     		      insertTr += ' </select></td>';
    		     		      insertTr += ' <td><input type=text id="source_path_'+idx+'" name="source_path" value="" readonly></td>';
    		     		      insertTr += ' <td><select id="pre_id" onchange="preIdChange('+idx+', this.value);"><option value="">선택</option>';
    		     		      $.each(dpIngestAdapterItPreData, function (idx2, el2) {
    			     		      insertTr += ' <option value="'+el2.pre_id+'" '+(el2.pre_id === el.pre_id?"selected":"")+'>'+el2.pre_nm+'</option>';
    		     		      });
    		     		      insertTr += ' </select></td>';
    		     		      
    		     		      insertTr += ' <td><input type=text id="property_type_'+idx+'" name="property_type" value="" readonly></td>';
    		     		      insertTr += ' <td><input type=text id="pre_after_'+idx+'" name="pre_after" value="" readonly></td>';
    		                  insertTr += '</tr>';
    			  	    });
    			  	    
    			  	    $("#dpIngestAdapterItMatchList").append(insertTr);		
    			  	    
			  	   	}
		  	  }
	    	  
	    }).fail(function (error) {
	        alert(JSON.stringify(error));
	    });	
	    
}

//Instance 매칭정보 리스트 조회
const dpIngestAdapterItMatchList = function(){

	$("#dpIngestAdapterItMatchList").empty();	
	
    const data = {
	   		url: '/dp/ingest/adapter/instance/match/list',
	   		instance_id: '{{instance_id}}',	
	   		user_id: 'user00',	
	   		menu_id: 'menu_id',
	    };		
	    
	    $.ajax({
	        type: 'POST',
	        url: url+'/dpIngestAdapterItMatchList',
	        dataType: 'json',
	        contentType: 'application/json; charset-utf-8',
	        data: JSON.stringify(data)
	    }).done(function (data) {
	    	
		  	  if (data != null) {
		  		  
	    		  if(errorMsg(data)){
	  	          	 return;  
        	  	  }	
		  		
			  	   	if(data.contents != ""){    	
			  	   		
    		     	    let insertTr = '';
    			  	    $.each(data.contents, function (idx, el) {
    			  	    	
  		     	          insertTr += '<tr>';
		     		      insertTr += ' <td><input type=hidden id="column_eng_nm" name="column_eng_nm" value="'+el.column_eng_nm+'">'+el.column_eng_nm+'</td>';
		     		      insertTr += ' <td><input type=hidden id="column_stre_type" name="column_stre_type" value="'+el.column_stre_type+'">'+el.column_stre_type+'</td>';
		     		      insertTr += ' <td><select id="source_id" name="source_id"><option value="">선택</option>';
		     		      $.each(dpIngestAdapterItSourceData, function (idx2, el2) {
			     		      insertTr += ' <option value="'+el2.source_id+'" '+(el2.source_id === el.source_id?"selected":"")+'>'+el2.source_id+'</option>';
		     		      });		     		      
		     		      insertTr += ' </select></td>';
		     		      insertTr += ' <td><input type=text id="source_path_'+idx+'" name="source_path" value="'+el.source_path+'"></td>';
		     		      insertTr += ' <td><select id="pre_id"><option value="">선택</option>';
		     		      $.each(dpIngestAdapterItPreData, function (idx2, el2) {
			     		      insertTr += ' <option value="'+el2.pre_id+'" '+(el2.pre_id === el.pre_id?"selected":"")+'>'+el2.pre_nm+'</option>';
		     		      });
		     		      insertTr += ' </select></td>';
		     		      
		     		      insertTr += ' <td><input type=text id="property_type_'+idx+'" name="property_type" value="'+el.property_type+'"></td>';
		     		      insertTr += ' <td><input type=text id="pre_after_'+idx+'" name="pre_after" value="'+el.pre_after+'"></td>';
		                  insertTr += '</tr>';
		                  
    			  	    });
    	          	    $("#dpIngestAdapterItMatchList").append(insertTr);		  
			  	   		
			  	   	}else{
			  	   		
			  	 		setTimeout(function() {
			  	 			dpIngestMetaTblCol();
			  	 		}, 300);
			  	   	}
		  	  }
	    	  
	    }).fail(function (error) {
	        alert(JSON.stringify(error));
	    });	
	    
}

//Instance 매칭정보 조회
const dpIngestAdapterItMatch = function(){
	
    const data = {
	   		url: '/dp/ingest/adapter/instance/match',
	   		instance_id: '{{instance_id}}',	
	   		user_id: 'user00',	
	   		menu_id: 'menu_id',
	    };		
	    
	    $.ajax({
	        type: 'POST',
	        url: url+'/dpIngestAdapterItMatch',
	        dataType: 'json',
	        contentType: 'application/json; charset-utf-8',
	        data: JSON.stringify(data)
	    }).done(function (data) {
	    	
		  	  if (data != null) {
		  		  
	    		  if(errorMsg(data)){
	  	          	 return;  
        	  	  }	
		  			
			  	   	if(data.contents != ""){    	
			  	   		$("#instance_nm_txt").text(data.contents[0].instance_nm);
			  	   		$("#dset_korean_nm_txt").text(data.contents[0].dset_korean_nm);
			  	   		
			  	   		$("#dset_idntfc_id").val(data.contents[0].dset_idntfc_id);
			  	   		$("#url_mix").val(data.contents[0].url_mix);
			  	   		$("#id_mix").val(data.contents[0].id_mix);
			  	   		if(isEmpty(data.contents[0].id_mix) === ''){
				  	   		$("#drake_pre").val(data.contents[0].table_eng_nm+".");
			  	   		}else{
			  	   			
			  	   			if(isEmpty(data.contents[0].id_mix.substr(data.contents[0].id_mix.indexOf(".")+1)) === ''){
					  	   		$("#drake_pre").val(data.contents[0].id_mix+".");
			  	   			}else{
				  	   			$("#drake_pre").val(data.contents[0].id_mix.substr(0, data.contents[0].id_mix.indexOf(".")+1));
						  	   	$(".drake_result").html(data.contents[0].id_mix);
					  	   		$("#pk_data_set").val(data.contents[0].id_mix);
			  	   			}
			  	   			
			  	   		}
			  	   		$("#clct_mthd").val(data.contents[0].clct_mthd);
			  	   		$("#clct_ty").val(data.contents[0].clct_ty);
			  	   		$("#subfolder_yn").val(data.contents[0].subfolder_yn);
			  	   		$("#table_eng_nm").val(data.contents[0].table_eng_nm);
			  	   		$("#api_mix").val(data.contents[0].api_mix);
			  	   		$("#table_idntfc_id").val(data.contents[0].table_idntfc_id);
			  	   		
			  	   	}
		  	  }
	    	  
	    }).fail(function (error) {
	        alert(JSON.stringify(error));
	    });		
	    
	    dpIngestAdapterItSource2();
	    dpIngestAdapterItPre();
	    
 		setTimeout(function() {
 			dpIngestAdapterItMatchList();
 		}, 300);
}

//Instance 매칭정보 저장
const dpIngestAdapterItMatchSave = function(){

	let lengthCnt = 0;
	let contentsData = new Array();
	
	if($("#pk_data_set").val() === ''){
		alert("ID설정을 해주세요");
		return;
	}
	$.each($("#tableDpIngestAdapterItMatchList tbody tr"), function(){
		 let itemObject = new Object();
		 itemObject.instance_id = '{{instance_id}}';
		 itemObject.column_eng_nm = $(this).find("#column_eng_nm").val();
		 itemObject.column_stre_type = $(this).find("#column_stre_type").val();
		 itemObject.source_id = $(this).find("#source_id").val();
		 itemObject.source_path = $("#source_path_"+lengthCnt).val();
		 itemObject.pre_nm = $(this).find("#pre_id option:checked").text();
		 itemObject.property_type = $("#property_type_"+lengthCnt).val();
		 itemObject.pre_after = $("#pre_after_"+lengthCnt).val();
		 itemObject.pre_id = $(this).find("#pre_id").val();
		 contentsData.push(itemObject);
		 
		 ++lengthCnt;
	});
	
    const data = {
	   		url: '/dp/ingest/adapter/instance/match/save',
	   		instance_id: '{{instance_id}}',	
	   		id_mix: $("#pk_data_set").val(),
	   		dset_idntfc_id: $("#dset_idntfc_id").val(),
	   		clct_mthd: $("#clct_mthd").val(),
	   		clct_ty: $("#clct_ty").val(),
	   		subfolder_yn: $("#subfolder_yn").val(),
	   		table_eng_nm: $("#table_eng_nm").val(),
	   		user_id: 'user00',	
	   		menu_id: 'menu_id',
	   		contents: contentsData,
	    };			
        
    	console.log(JSON.stringify(data));
    	
	    $.ajax({
	        type: 'POST',
	        url: url+'/dpIngestAdapterItMatchSave',
	        dataType: 'json',
	        contentType: 'application/json; charset-utf-8',
	        data: JSON.stringify(data)
        }).done(function (data) {
  	  	  if (data != null) {
  	  		  
    		  if(errorMsg(data)){
  	          	 return;  
       	  	  }	
  	  		
		  	   	if(data.contents != ""){    	   
	  	   			if(data.contents[0].successYn === 'Y'){
		  	 	  		let message = JSON.stringify(data.return_msg);
		  		  		alert(message.replace(/\"/gi, ''));
	  	   			}
		  	   	}
	  	  }
        }).fail(function (error) {
            alert(JSON.stringify(error));
        });	
	    
}

//데이터 모델 속성 정보 조회 초기화
const dpIngestDataModelsPpInit = function(){

	$("#drakeLeft").html("");
	$("#drakeRight").html("");

	let drake_pre = $("#drake_pre").val();
   	$(".drake_result").html(drake_pre);
	  	   	
    const data = {
	   		url: '/dp/ingest/data/models/property?table_idntfc_id='+$("#table_idntfc_id").val(),
	    };		
	    
	    $.ajax({
	        type: 'POST',
	        url: commonUrl+'/dpIngestDataModelsPp',
	        dataType: 'json',
	        contentType: 'application/json; charset-utf-8',
	        data: JSON.stringify(data)
	    }).done(function (data) {
		  	  if (data != null) {
		  		  
	    		  if(errorMsg(data)){
	  	          	 return;  
        	  	  }	
		  		
			  	   	if(data.contents != ""){    	
			  	   		let li = '';
    			  	    $.each(data.contents, function (idx, el) {
	    			  	   	li += '<li class="task"><p>'+el.column_eng_nm+'('+el.column_stre_type+')</p></li>';
    			  	    });
    			  	 	$("#drakeLeft").append(li);
			  	   	}
		  	  }
	    	  
	    }).fail(function (error) {
	        alert(JSON.stringify(error));
	    });			
}

//데이터 모델 속성 정보 조회
const dpIngestDataModelsPp = function(){
	
	$("#drakeLeft").empty();
	$("#drakeRight").empty();
	
	if($(".drake_result").html() === ''){
		let drake_pre = $("#drake_pre").val();
	   	$(".drake_result").html(drake_pre);		
	}
    const data = {
	   		url: '/dp/ingest/data/models/property?table_idntfc_id='+$("#table_idntfc_id").val(),
	    };		
	    
	    $.ajax({
	        type: 'POST',
	        url: commonUrl+'/dpIngestDataModelsPp',
	        dataType: 'json',
	        contentType: 'application/json; charset-utf-8',
	        data: JSON.stringify(data)
	    }).done(function (data) {
		  	  if (data != null) {
		  		  
	    		  if(errorMsg(data)){
	  	          	 return;  
        	  	  }	
		  		
			  	   	if(data.contents != ""){    	
			  	   		let li = '';
			  	   		let pk_data_set = $("#pk_data_set").val();
			  	   		let arr;
			  	   		let arrValue = [];
			  	   		let arr2 = [];
			  	   		
			  	   		if(pk_data_set !== ''){
			  	   			arr = pk_data_set.split(".");
			  	   		}
			  	   		//오른쪽
			  	   		
    			  	    $.each(data.contents, function (idx, el) {
    			  	    	
    			  	    	if(isEmpty(arr) !== ''){
	    			  	    	for(var i=0; i<arr.length;i++){
		    			  	    	if(arr[i] === el.column_eng_nm){
		    			  	    		arrValue.push(el.column_stre_type);
		    			  	    	}
	    			  	    	}
    			  	    	}
    			  	    	arr2.push(el.column_eng_nm);
    			  	    });
			  	   		
    			  	   if(isEmpty(arr) !== ''){
    			  	    	for(var i=1; i<arr.length;i++){
    			  	    		if(arr[i] !== ''){
			    			  	   	li = '<li class="task"><p>'+arr[i]+'('+arrValue[i-1]+')</p></li>';
			    			  	 	$("#drakeRight").append(li);
    			  	    		}
    			  	    	}
		    			  	//왼쪽
	    			  	  	let values = arr2.filter(x => !arr.includes(x));
	    			  	    $.each(data.contents, function (idx, el) {
	    			  	    	for(var i=0; i<values.length;i++){
		    			  	    	if(el.column_eng_nm === values[i]){
				    			  	   	li = '<li class="task"><p>'+el.column_eng_nm+'('+el.column_stre_type+')</p></li>';
				    			  	 	$("#drakeLeft").append(li);
		    			  	    	}
	    			  	    	}
	    			  	    });
    			  		}else{
    			  			
    				  	   	if(data.contents != ""){    	
    				  	   		let li = '';
    	    			  	    $.each(data.contents, function (idx, el) {
    		    			  	   	li += '<li class="task"><p>'+el.column_eng_nm+'('+el.column_stre_type+')</p></li>';
    	    			  	    });
    	    			  	 	$("#drakeLeft").append(li);
    				  	   	}    			  			
    			  		}
    			  	  
			  	   	}
		  	  }
	    	  
	    }).fail(function (error) {
	        alert(JSON.stringify(error));
	    });			
}


const idSetIdMix = function(){
	$("#pk_data_set").val($(".drake_result").html());
	
	$('#idSet').modal('hide');
}
//전처리 조회

const dpIngestAdapterItPre = function(){
	
    const data = {
	   		url: '/dp/ingest/adapter/instance/pre',
	   		user_id: 'user00',	
	   		menu_id: 'menu_id',
	    };		
	    
	    $.ajax({
	        type: 'POST',
	        url: url+'/dpIngestAdapterItPre',
	        dataType: 'json',
	        contentType: 'application/json; charset-utf-8',
	        data: JSON.stringify(data)
	    }).done(function (data) {
		  	  if (data != null) {
			  	   	if(data.contents != ""){    	
					  	
			  	   	dpIngestAdapterItPreData = data.contents;
		                  let insertTr = '';
					  	    $.each(data.contents, function (idx, el) {
		    			  		  
				                  $("#divForm").append($("<input type='hidden' value='"+el.property_type+"' id='div_"+el.pre_id+"_property_type'>"));
				                  $("#divForm").append($("<input type='hidden' value='"+el.pre_after+"' id='div_"+el.pre_id+"_pre_after'>"));
					  	    });
			        //  	    $("#dpIngestAdapterItMatchList").append(insertTr);			                  
		                  
			  	   	}
			  	   	
		     	  			  	   	
		  	  }
	    	  
	    }).fail(function (error) {
	        alert(JSON.stringify(error));
	    });		
}


//API 데이터 구조 조회
/*
const dpIngestAdapterItPath = function(){

    const data = {
	   		url: '/dp/ingest/adapter/instance/path',
	   		instance_id: '{{instance_id}}',	
	   		user_id: 'user00',	
	   		menu_id: 'menu_id',
	    };		
	    
	    $.ajax({
	        type: 'POST',
	        url: url+'/dpIngestAdapterItPath',
	        dataType: 'json',
	        contentType: 'application/json; charset-utf-8',
	        data: JSON.stringify(data)
	    }).done(function (data) {
		  	  if (data != null) {
			  	   	if(data.contents != ""){    
				  	   	data.contents[0].api_mix;
			  	   	}
		  	  }
	    	  
	    }).fail(function (error) {
	        alert(JSON.stringify(error));
	    });		
}
*/

//ID 설정 Source 조회
const dpIngestAdapterItSource = function(){
	
    const data = {
	   		url: '/dp/ingest/adapter/instance/source',
	   		instance_id: '{{instance_id}}',	
	   		user_id: 'user00',	
	   		menu_id: 'menu_id',
	    };		
	    
	    $.ajax({
	        type: 'POST',
	        url: url+'/dpIngestAdapterItSource',
	        dataType: 'json',
	        contentType: 'application/json; charset-utf-8',
	        data: JSON.stringify(data)
	    }).done(function (data) {
		  	  if (data != null) {
		  		  
	    		  if(errorMsg(data)){
	  	          	 return;  
        	  	  }	
			  	   	if(data.contents != ""){    
				  	   	
			  	   		$.each(data.contents, function (idx, el) {
				  	  		$("#divForm").append($("<input type='hidden' value='"+el.choice_yn+"' id='div_"+el.source_id.replace(/\./gi, '_')+"_"+el.source_path.replace(/\./gi, '_')+"'>"));
			  		    });	  
			  	   	}
		  	  }
	    	  
	    }).fail(function (error) {
	        alert(JSON.stringify(error));
	    });		
	    
	    dpIngestPopupPpPath();
}

//ID 설정 Source 조회
const dpIngestAdapterItSource2 = function(){
	
    const data = {
	   		url: '/dp/ingest/adapter/instance/source',
	   		instance_id: '{{instance_id}}',	
	   		user_id: 'user00',	
	   		menu_id: 'menu_id',
	    };		
	    
	    $.ajax({
	        type: 'POST',
	        url: url+'/dpIngestAdapterItSource',
	        dataType: 'json',
	        contentType: 'application/json; charset-utf-8',
	        data: JSON.stringify(data)
	    }).done(function (data) {
		  	  if (data != null) {
		  		  
	    		  if(errorMsg(data)){
	  	          	 return;  
        	  	  }	
			  	   	if(data.contents != ""){    	
			  	   	dpIngestAdapterItSourceData = data.contents;
			  	   	
			  	   	let insertTr = '';
			  	   		$.each(data.contents, function (idx, el) {
			  	   				
			  	   			  $("#divForm").append($("<input type='hidden' value='"+el.source_path+"' id='div_"+el.source_id+"'>"));
			  		    });	  
			  	   		
			  	   	}
		  	  }
	    	  
	    }).fail(function (error) {
	        alert(JSON.stringify(error));
	    });		
	    
}

//API 수신경로 전체 저장
const dpIngestPopupPpPathSave = function(){

	let lengthCnt = 0;
	let contentsData = new Array();
	
	let adaptorSetDataConfigLen = $("#tableDpIngestPopupPpPath tbody tr").length;
	
	if(adaptorSetDataConfigLen > 0){
		
		$.each($("#tableDpIngestPopupPpPath tbody tr"), function(){
			 let itemObject = new Object();
			 itemObject.instance_id = '{{instance_id}}';
			 itemObject.source_id = $(this).find("#source_id").val();
			 itemObject.source_path = $(this).find("#source_path").val();
			 itemObject.choice_yn = $(this).find("#choice_yn").is(':checked') == true ?'Y':'N';
			 itemObject.user_id = 'user00';
			 contentsData.push(itemObject);
		});
		
	    const data = {
		   		url: '/dp/ingest/popup/property_path/save',
		   		instance_id: '{{instance_id}}',	
		   		user_id: 'user00',	
		   		menu_id: 'menu_id',
		   		contents: contentsData,
		    };		
		    
	    	console.log('data:'+JSON.stringify(data));
	    	
		    $.ajax({
		        type: 'POST',
		        url: url+'/dpIngestPopupPpPathSave',
		        dataType: 'json',
		        contentType: 'application/json; charset-utf-8',
		        data: JSON.stringify(data)
		    }).done(function (data) {
			  	  if (data != null) {
			  		  
		    		  if(errorMsg(data)){
		  	          	 return;  
	        	  	  }	
			  			
			  			if(data.contents[0].successYn === 'Y'){
			  	 	  		let message = JSON.stringify(data.return_msg);
			  		  		alert(message.replace(/\"/gi, ''));
			  		  		
			  			    dpIngestAdapterItSource2();
			  		 		setTimeout(function() {
			  		 			dpIngestAdapterItMatchList();
			  		 		}, 300);			  		  		
				  	   	}
				  	   	
				  	  	$('#apiDataSet').modal('hide');
				  	   	
			  	  }
		    	  
		    }).fail(function (error) {
		        alert(JSON.stringify(error));
		    });	
	}
	    
}

//수신경로 조회(API 설정정보를 조합하여 조회)

const dpIngestPopupPpPath = function(){
	
	$("#dpIngestPopupPpPath").empty();	
	
    const data = {
	   		url: '/dp/ingest/popup/property_path',
	   		instance_id: '{{instance_id}}',	
	   		user_id: 'user00',	
	   		menu_id: 'menu_id',
	    };		
	    
	    $.ajax({
	        type: 'POST',
	        url: url+'/dpIngestPopupPpPath',
	        dataType: 'json',
	        contentType: 'application/json; charset-utf-8',
	        data: JSON.stringify(data)
	    }).done(function (data) {
	    	
		  	  if (data != null) {
		  		  
	    		  if(errorMsg(data)){
	  	          	 return;  
        	  	  }	
		  			
			  	   	if(data.contents != ""){    	
	   		     	    let insertTr = '';
    			  	    $.each(data.contents, function (idx, el) {
    			  	    	
	  		     	          insertTr += '<tr>';
			     		      insertTr += ' <td><input type=checkbox name="choice_yn" id="choice_yn" value="Y" '+($("#div_"+el.source_id.replace(/\./gi, '_')+"_"+el.source_path.replace(/\./gi, '_')).val() === 'Y'?'checked':'')+'></td>';
			     		      insertTr += ' <td><input type=hidden value='+el.source_path+' name="source_path" id="source_path" >'+el.source_path+'</td>';
			     		      insertTr += ' <td><input type=hidden value='+el.source_id+' name="source_id" id="source_id" >'+el.source_id+'</td>';
			                  insertTr += '</tr>';
		    			  	    
    			  	    });	  			  	    
     			  	   $("#dpIngestPopupPpPath").append(insertTr);		 
    			  	    
			  	   	}
			  	  	
		  	  }
	    	  
		  	  
	    }).fail(function (error) {
	        alert(JSON.stringify(error));
	    });		
}

const sourceIdChange = function(idx, source_id){
	
	$("#source_path_"+idx).val($("#div_"+source_id).val());
}

const preIdChange = function(idx, pre_id){
	
	$("#property_type_"+idx).val($("#div_"+pre_id+"_property_type").val());
	$("#pre_after_"+idx).val($("#div_"+pre_id+"_pre_after").val());
}

//모달 열기
const openModal = function(modalId){
	
	if(modalId === 'idSet'){
		dpIngestDataModelsPp();
	}else if(modalId === 'apiDataSet'){
		dpIngestAdapterItSource();
	}
	$('#'+modalId).modal('show');
}


dpIngestAdapterItMatch();
</script>

